define(["@grafana/data","@grafana/ui","react","@emotion/css","lodash","@grafana/runtime","rxjs"],((e,t,r,n,i,o,a)=>(()=>{"use strict";var l={644:e=>{e.exports=n},305:t=>{t.exports=e},545:e=>{e.exports=o},388:e=>{e.exports=t},980:e=>{e.exports=i},650:e=>{e.exports=r},177:e=>{e.exports=a}},s={};function c(e){var t=s[e];if(void 0!==t)return t.exports;var r=s[e]={exports:{}};return l[e](r,r.exports,c),r.exports}c.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return c.d(t,{a:t}),t},c.d=(e,t)=>{for(var r in t)c.o(t,r)&&!c.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},c.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),c.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),c.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var u={};return(()=>{c.r(u),c.d(u,{plugin:()=>It});var e=c(305),t=c(388),r=c(650),n=c.n(r),i=c(644);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const a=[{label:"Builder",value:"builder",component:()=>n().createElement(t.Tag,{className:(0,i.css)({fontSize:10,padding:"1px 5px",verticalAlign:"text-bottom"}),name:"Experimental",colorIndex:1})},{label:"Code",value:"code"}];function l(e){var r,i,{mode:l}=e,s=function(e,t){if(null==e)return{};var r,n,i=function(e,t){if(null==e)return{};var r,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}(e,["mode"]);return n().createElement("div",{"data-testid":"QueryEditorModeToggle"},n().createElement(t.RadioButtonGroup,(r=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){o(e,t,r[t])}))}return e}({size:"sm"},s),i=null!=(i={options:a,value:l})?i:{},Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(i)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(i)).forEach((function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(i,e))})),r)))}function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){s(e,t,r[t])}))}return e}function p(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const{FormField:h}=t.LegacyForms;var f;const m=({children:e})=>{const r=(0,t.useStyles2)(g);return n().createElement("div",{className:r.root},e)},g=e=>({root:(0,i.css)({display:"flex",flexWrap:"wrap",alignItems:"center",gap:e.spacing(3),minHeight:e.spacing(4)})});var y=Object.getOwnPropertySymbols,v=Object.prototype.hasOwnProperty,b=Object.prototype.propertyIsEnumerable;const O=e=>{var i=e,{children:o}=i,a=((e,t)=>{var r={};for(var n in e)v.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&y)for(var n of y(e))t.indexOf(n)<0&&b.call(e,n)&&(r[n]=e[n]);return r})(i,["children"]);const l=(0,t.useStyles2)((0,r.useCallback)((e=>w(e,a)),[a]));return n().createElement("div",{className:l.root},o)},w=(e,t)=>{var r,n,o;return{root:(0,i.css)({display:"flex",flexDirection:null!=(r=t.direction)?r:"row",flexWrap:null==(n=t.wrap)||n?"wrap":void 0,alignItems:t.alignItems,gap:e.spacing(null!=(o=t.gap)?o:2),flexGrow:t.flexGrow})}},_=({children:e})=>n().createElement(O,{gap:.5,direction:"column"},e),E=({children:e})=>n().createElement(O,{gap:1},e),S=e=>{const o=(0,t.useStyles2)((0,r.useCallback)((t=>j(t,e)),[e]));return n().createElement("span",{className:(0,i.cx)(o.wrapper)})};S.defaultProps={v:0,h:0,layout:"block"};const j=(e,t)=>{var r,n;return{wrapper:(0,i.css)([{paddingRight:e.spacing(null!=(r=t.h)?r:0),paddingBottom:e.spacing(null!=(n=t.v)?n:0)},"inline"===t.layout&&{display:"inline-block"},"block"===t.layout&&{display:"block"}])}};var x=Object.defineProperty,P=Object.getOwnPropertySymbols,T=Object.prototype.hasOwnProperty,z=Object.prototype.propertyIsEnumerable,N=(e,t,r)=>t in e?x(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;const F=e=>{var i;const o=e,{label:a,optional:l,tooltip:s,tooltipInteractive:c,children:u,width:d}=o,p=((e,t)=>{var r={};for(var n in e)T.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&P)for(var n of P(e))t.indexOf(n)<0&&z.call(e,n)&&(r[n]=e[n]);return r})(o,["label","optional","tooltip","tooltipInteractive","children","width"]),h=(0,t.useStyles2)((0,r.useCallback)((e=>C(e,d)),[d])),f=(null==p?void 0:p.htmlFor)||(null==(i=t.ReactUtils)?void 0:i.getChildId(u)),m=n().createElement(n().Fragment,null,n().createElement("label",{className:h.label,htmlFor:f},a,l&&n().createElement("span",{className:h.optional}," - optional"),s&&n().createElement(t.Tooltip,{placement:"top",content:s,theme:"info",interactive:c},n().createElement(t.Icon,{tabIndex:0,name:"info-circle",size:"sm",className:h.icon}))),n().createElement(S,{v:.5}));return n().createElement("div",{className:h.root},n().createElement(t.Field,((e,t)=>{for(var r in t||(t={}))T.call(t,r)&&N(e,r,t[r]);if(P)for(var r of P(t))z.call(t,r)&&N(e,r,t[r]);return e})({className:h.field,label:m},p),u))},C=(e,t)=>({root:(0,i.css)({minWidth:e.spacing(null!=t?t:0)}),label:(0,i.css)({fontSize:12,fontWeight:e.typography.fontWeightMedium}),optional:(0,i.css)({fontStyle:"italic",color:e.colors.text.secondary}),field:(0,i.css)({marginBottom:0}),icon:(0,i.css)({color:e.colors.text.secondary,marginLeft:e.spacing(1),":hover":{color:e.colors.text.primary}})});let k;k="undefined"!=typeof window?window:"undefined"!=typeof self?self:c.g;let D=null,M=null;const A=k.clearTimeout,R=k.setTimeout,I=k.cancelAnimationFrame||k.mozCancelAnimationFrame||k.webkitCancelAnimationFrame,L=k.requestAnimationFrame||k.mozRequestAnimationFrame||k.webkitRequestAnimationFrame;null==I||null==L?(D=A,M=function(e){return R(e,20)}):(D=function([e,t]){I(e),A(t)},M=function(e){const t=L((function(){A(r),e()})),r=R((function(){I(t),e()}),20);return[t,r]});class $ extends r.Component{constructor(...e){super(...e),this.state={height:this.props.defaultHeight||0,scaledHeight:this.props.defaultHeight||0,scaledWidth:this.props.defaultWidth||0,width:this.props.defaultWidth||0},this._autoSizer=null,this._detectElementResize=null,this._parentNode=null,this._resizeObserver=null,this._timeoutId=null,this._onResize=()=>{this._timeoutId=null;const{disableHeight:e,disableWidth:t,onResize:r}=this.props;if(this._parentNode){var n,i,o,a;const l=window.getComputedStyle(this._parentNode)||{},s=parseFloat(null!==(n=l.paddingLeft)&&void 0!==n?n:"0"),c=parseFloat(null!==(i=l.paddingRight)&&void 0!==i?i:"0"),u=parseFloat(null!==(o=l.paddingTop)&&void 0!==o?o:"0"),d=parseFloat(null!==(a=l.paddingBottom)&&void 0!==a?a:"0"),p=this._parentNode.getBoundingClientRect(),h=p.height-u-d,f=p.width-s-c,m=this._parentNode.offsetHeight-u-d,g=this._parentNode.offsetWidth-s-c;(e||this.state.height===m&&this.state.scaledHeight===h)&&(t||this.state.width===g&&this.state.scaledWidth===f)||(this.setState({height:m,width:g,scaledHeight:h,scaledWidth:f}),"function"==typeof r&&r({height:m,scaledHeight:h,scaledWidth:f,width:g}))}},this._setRef=e=>{this._autoSizer=e}}componentDidMount(){const{nonce:e}=this.props;this._autoSizer&&this._autoSizer.parentNode&&this._autoSizer.parentNode.ownerDocument&&this._autoSizer.parentNode.ownerDocument.defaultView&&this._autoSizer.parentNode instanceof this._autoSizer.parentNode.ownerDocument.defaultView.HTMLElement&&(this._parentNode=this._autoSizer.parentNode,null!=this._parentNode&&("undefined"!=typeof ResizeObserver?(this._resizeObserver=new ResizeObserver((()=>{this._timeoutId=setTimeout(this._onResize,0)})),this._resizeObserver.observe(this._parentNode)):(this._detectElementResize=function(e){let t,r,n,i,o,a,l;const s="undefined"!=typeof document&&document.attachEvent;if(!s){a=function(e){const t=e.__resizeTriggers__,r=t.firstElementChild,n=t.lastElementChild,i=r.firstElementChild;n.scrollLeft=n.scrollWidth,n.scrollTop=n.scrollHeight,i.style.width=r.offsetWidth+1+"px",i.style.height=r.offsetHeight+1+"px",r.scrollLeft=r.scrollWidth,r.scrollTop=r.scrollHeight},o=function(e){return e.offsetWidth!==e.__resizeLast__.width||e.offsetHeight!==e.__resizeLast__.height},l=function(e){if(e.target.className&&"function"==typeof e.target.className.indexOf&&e.target.className.indexOf("contract-trigger")<0&&e.target.className.indexOf("expand-trigger")<0)return;const t=this;a(this),this.__resizeRAF__&&D(this.__resizeRAF__),this.__resizeRAF__=M((function(){o(t)&&(t.__resizeLast__.width=t.offsetWidth,t.__resizeLast__.height=t.offsetHeight,t.__resizeListeners__.forEach((function(r){r.call(t,e)})))}))};let e=!1,s="";n="animationstart";const c="Webkit Moz O ms".split(" ");let u="webkitAnimationStart animationstart oAnimationStart MSAnimationStart".split(" "),d="";{const t=document.createElement("fakeelement");if(void 0!==t.style.animationName&&(e=!0),!1===e)for(let r=0;r<c.length;r++)if(void 0!==t.style[c[r]+"AnimationName"]){d=c[r],s="-"+d.toLowerCase()+"-",n=u[r],e=!0;break}}r="resizeanim",t="@"+s+"keyframes "+r+" { from { opacity: 0; } to { opacity: 0; } } ",i=s+"animation: 1ms "+r+"; "}return{addResizeListener:function(o,c){if(s)o.attachEvent("onresize",c);else{if(!o.__resizeTriggers__){const s=o.ownerDocument,c=k.getComputedStyle(o);c&&"static"===c.position&&(o.style.position="relative"),function(r){if(!r.getElementById("detectElementResize")){const n=(t||"")+".resize-triggers { "+(i||"")+'visibility: hidden; opacity: 0; } .resize-triggers, .resize-triggers > div, .contract-trigger:before { content: " "; display: block; position: absolute; top: 0; left: 0; height: 100%; width: 100%; overflow: hidden; z-index: -1; } .resize-triggers > div { background: #eee; overflow: auto; } .contract-trigger:before { width: 200%; height: 200%; }',o=r.head||r.getElementsByTagName("head")[0],a=r.createElement("style");a.id="detectElementResize",a.type="text/css",null!=e&&a.setAttribute("nonce",e),a.styleSheet?a.styleSheet.cssText=n:a.appendChild(r.createTextNode(n)),o.appendChild(a)}}(s),o.__resizeLast__={},o.__resizeListeners__=[],(o.__resizeTriggers__=s.createElement("div")).className="resize-triggers";const u=s.createElement("div");u.className="expand-trigger",u.appendChild(s.createElement("div"));const d=s.createElement("div");d.className="contract-trigger",o.__resizeTriggers__.appendChild(u),o.__resizeTriggers__.appendChild(d),o.appendChild(o.__resizeTriggers__),a(o),o.addEventListener("scroll",l,!0),n&&(o.__resizeTriggers__.__animationListener__=function(e){e.animationName===r&&a(o)},o.__resizeTriggers__.addEventListener(n,o.__resizeTriggers__.__animationListener__))}o.__resizeListeners__.push(c)}},removeResizeListener:function(e,t){if(s)e.detachEvent("onresize",t);else if(e.__resizeListeners__.splice(e.__resizeListeners__.indexOf(t),1),!e.__resizeListeners__.length){e.removeEventListener("scroll",l,!0),e.__resizeTriggers__.__animationListener__&&(e.__resizeTriggers__.removeEventListener(n,e.__resizeTriggers__.__animationListener__),e.__resizeTriggers__.__animationListener__=null);try{e.__resizeTriggers__=!e.removeChild(e.__resizeTriggers__)}catch(e){}}}}}(e),this._detectElementResize.addResizeListener(this._parentNode,this._onResize)),this._onResize()))}componentWillUnmount(){this._parentNode&&(this._detectElementResize&&this._detectElementResize.removeResizeListener(this._parentNode,this._onResize),null!==this._timeoutId&&clearTimeout(this._timeoutId),this._resizeObserver&&(this._resizeObserver.observe(this._parentNode),this._resizeObserver.disconnect()))}render(){const{children:e,defaultHeight:t,defaultWidth:n,disableHeight:i=!1,disableWidth:o=!1,nonce:a,onResize:l,style:s={},tagName:c="div",...u}=this.props,{height:d,scaledHeight:p,scaledWidth:h,width:f}=this.state,m={overflow:"visible"},g={};let y=!1;return i||(0===d&&(y=!0),m.height=0,g.height=d,g.scaledHeight=p),o||(0===f&&(y=!0),m.width=0,g.width=f,g.scaledWidth=h),(0,r.createElement)(c,{ref:this._setRef,style:{...m,...s},...u},!y&&e(g))}}var V=c(980);function W(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const B=({datasource:e,onChange:r,onRunQuery:i,query:o,payload:a})=>{const[l,s]=n().useState(),[c,u]=n().useState(null!=a?a:""),[d,p]=n().useState(null),[h,f]=n().useState([]),[m,g]=n().useState(!1),y=n().useCallback((()=>e.listMetrics("",void 0).then((e=>{const t=e.map((e=>({label:e.label,value:e.value}))),r=(0,V.find)(t,(e=>e.value===o.target));return s(void 0===r?{label:"",value:""}:r),t}),(e=>{throw s({label:"",value:""}),f([]),new Error(e.statusText)}))),[e,o.target]),v=n().useCallback((()=>{g(!0),y().then((e=>{f(e)})).finally((()=>{g(!1)}))}),[y,f,g]);return n().useEffect((()=>v()),[]),n().useEffect((()=>{var e,t;void 0!==l?.value&&""!==l?.value&&(null!==d&&l?.value===d.metric&&c===d.payload||(p({payload:c,metric:l.value.toString()}),r((e=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){W(e,t,r[t])}))}return e}({},o),t=null!=(t={payload:c,target:l.value.toString()})?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e)),i()))}),[c,l]),n().createElement(n().Fragment,null,n().createElement(t.InlineFieldRow,null,n().createElement(t.InlineField,null,n().createElement(t.Select,{isLoading:m,prefix:"Metric: ",options:h,placeholder:"Select metric",allowCustomValue:!0,value:l,onChange:e=>{s(e)}}))),n().createElement(t.InlineFieldRow,null,n().createElement($,{disableHeight:!0},(({width:e})=>n().createElement("div",{style:{width:e+"px"}},n().createElement(t.InlineLabel,null,"Payload"),n().createElement(t.CodeEditor,{width:"100%",height:"200px",language:"json",showLineNumbers:!0,showMiniMap:c.length>100,value:c,onBlur:e=>u(e)}))))))},H=(0,t.withTheme2)((({theme:e,onValueChange:t,value:r})=>{const o=(e=>{const t=function(e){return{outline:"2px dotted transparent",outlineOffset:"2px",boxShadow:`0 0 0 2px ${e.colors.background.canvas}, 0 0 0px 4px ${e.colors.primary.main}`,transitionTimingFunction:"cubic-bezier(0.19, 1, 0.22, 1)",transitionDuration:"0.2s",transitionProperty:"outline, outline-offset, box-shadow"}}(e);return{wrapper:i.css`
      &:focus-within {
        ${t}
      }
    `}})(e),a=n().useRef(void 0===r?"</div>":`<div>${r.replace(/([^\n])\n/g,"$1</div><div>").replace(/\n/g,"</div><div><br /></div><div>")}`);return n().createElement("div",{className:(0,i.cx)("slate-query-field__wrapper",o.wrapper)},n().createElement("div",{dangerouslySetInnerHTML:{__html:a.current},contentEditable:!0,style:{width:"100%",outline:"none"},onBlur:e=>{t(e.currentTarget.innerText.replace(/\n\n/g,"\n"))},onInput:e=>{a.current=e.currentTarget.innerHTML}}))}));function q(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const J=({config:e,datasource:r,query:i,onPayloadChange:o,isMulti:a,value:l})=>{const[s,c]=n().useState(),[u,d]=n().useState(!1),[p,h]=n().useState([]),f=n().useCallback((()=>{var t;return r.listMetricPayloadOptions(e.name,null!==(t=i.target)&&void 0!==t?t:"",i.payload).then((e=>{if(l){const i=r.getVariables();for(const t in i)Object.prototype.hasOwnProperty.call(i,t)&&e.push({label:`$${t}`,value:`$${t}`});if((0,V.isArray)(s))for(let t=0;t<s.length;t++)void 0!==e.find((e=>e.value===s[t].value))&&e.push({value:s[t].value,label:s[t].label});else s&&void 0!==e.find((e=>e.value===s.value))&&e.push((t=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){q(e,t,r[t])}))}return e}({},s),n=null!=(n={value:s.value,label:s.label})?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})),t))}var t,n;return e}),(e=>{throw h([]),new Error(e.statusText)}))}),[r,i.payload,i.target]),m=n().useCallback((()=>{d(!0),f().then((e=>{h(e)})).finally((()=>{d(!1)}))}),[f,h,d]);var g,y;return n().useEffect((()=>{l&&m()}),[]),n().useEffect((()=>{if(l)if((0,V.isArray)(l)){const e=p.filter((e=>(0,V.includes)(l,e.value)));e?c(e):l&&c([{label:l,value:l}])}else{const e=p.find((e=>e.value===l));e?c(e):l&&c({label:l.toString(),value:l})}else c(void 0)}),[i.payload,p]),n().createElement(t.Select,{key:e.name,width:e.width,isLoading:u,prefix:e.label,options:null!==(g=e.options)&&void 0!==g?g:p,placeholder:null!==(y=e.placeholder)&&void 0!==y?y:"",allowCustomValue:!0,isClearable:!0,isMulti:a,value:s,onOpenMenu:()=>{e.options||m()},onChange:e=>{o(e)}})},U=Symbol("@ts-pattern/matcher"),K=Symbol("@ts-pattern/isVariadic"),Q="@ts-pattern/anonymous-select-key",G=e=>Boolean(e&&"object"==typeof e),Y=e=>e&&!!e[U],X=(e,t,r)=>{if(Y(e)){const n=e[U](),{matched:i,selections:o}=n.match(t);return i&&o&&Object.keys(o).forEach((e=>r(e,o[e]))),i}if(G(e)){if(!G(t))return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;let n=[],i=[],o=[];for(const t of e.keys()){const r=e[t];Y(r)&&r[K]?o.push(r):o.length?i.push(r):n.push(r)}if(o.length){if(o.length>1)throw new Error("Pattern error: Using `...P.array(...)` several times in a single pattern is not allowed.");if(t.length<n.length+i.length)return!1;const e=t.slice(0,n.length),a=0===i.length?[]:t.slice(-i.length),l=t.slice(n.length,0===i.length?1/0:-i.length);return n.every(((t,n)=>X(t,e[n],r)))&&i.every(((e,t)=>X(e,a[t],r)))&&(0===o.length||X(o[0],l,r))}return e.length===t.length&&e.every(((e,n)=>X(e,t[n],r)))}return Object.keys(e).every((n=>{const i=e[n];return(n in t||Y(o=i)&&"optional"===o[U]().matcherType)&&X(i,t[n],r);var o}))}return Object.is(t,e)},Z=e=>{var t,r,n;return G(e)?Y(e)?null!=(t=null==(r=(n=e[U]()).getSelectionKeys)?void 0:r.call(n))?t:[]:Array.isArray(e)?ee(e,Z):ee(Object.values(e),Z):[]},ee=(e,t)=>e.reduce(((e,r)=>e.concat(t(r))),[]);function te(e){return Object.assign(e,{optional:()=>ne(e),and:t=>ae(e,t),or:t=>le(e,t),select:t=>void 0===t?ce(e):ce(t,e)})}function re(e){return Object.assign((e=>Object.assign(e,{*[Symbol.iterator](){yield Object.assign(e,{[K]:!0})}}))(e),{optional:()=>re(ne(e)),select:t=>re(void 0===t?ce(e):ce(t,e))})}function ne(e){return te({[U]:()=>({match:t=>{let r={};const n=(e,t)=>{r[e]=t};return void 0===t?(Z(e).forEach((e=>n(e,void 0))),{matched:!0,selections:r}):{matched:X(e,t,n),selections:r}},getSelectionKeys:()=>Z(e),matcherType:"optional"})})}const ie=(e,t)=>{for(const r of e)if(!t(r))return!1;return!0},oe=(e,t)=>{for(const[r,n]of e.entries())if(!t(n,r))return!1;return!0};function ae(...e){return te({[U]:()=>({match:t=>{let r={};const n=(e,t)=>{r[e]=t};return{matched:e.every((e=>X(e,t,n))),selections:r}},getSelectionKeys:()=>ee(e,Z),matcherType:"and"})})}function le(...e){return te({[U]:()=>({match:t=>{let r={};const n=(e,t)=>{r[e]=t};return ee(e,Z).forEach((e=>n(e,void 0))),{matched:e.some((e=>X(e,t,n))),selections:r}},getSelectionKeys:()=>ee(e,Z),matcherType:"or"})})}function se(e){return{[U]:()=>({match:t=>({matched:Boolean(e(t))})})}}function ce(...e){const t="string"==typeof e[0]?e[0]:void 0,r=2===e.length?e[1]:"string"==typeof e[0]?void 0:e[0];return te({[U]:()=>({match:e=>{let n={[null!=t?t:Q]:e};return{matched:void 0===r||X(r,e,((e,t)=>{n[e]=t})),selections:n}},getSelectionKeys:()=>[null!=t?t:Q].concat(void 0===r?[]:Z(r))})})}function ue(e){return"number"==typeof e}function de(e){return"string"==typeof e}function pe(e){return"bigint"==typeof e}const he=te(se((function(e){return!0}))),fe=he,me=e=>Object.assign(te(e),{startsWith:t=>{return me(ae(e,(r=t,se((e=>de(e)&&e.startsWith(r))))));var r},endsWith:t=>{return me(ae(e,(r=t,se((e=>de(e)&&e.endsWith(r))))));var r},minLength:t=>me(ae(e,(e=>se((t=>de(t)&&t.length>=e)))(t))),maxLength:t=>me(ae(e,(e=>se((t=>de(t)&&t.length<=e)))(t))),includes:t=>{return me(ae(e,(r=t,se((e=>de(e)&&e.includes(r))))));var r},regex:t=>{return me(ae(e,(r=t,se((e=>de(e)&&Boolean(e.match(r)))))));var r}}),ge=me(se(de)),ye=(e,t)=>se((r=>ue(r)&&e<=r&&t>=r)),ve=e=>se((t=>ue(t)&&t<e)),be=e=>se((t=>ue(t)&&t>e)),Oe=e=>se((t=>ue(t)&&t<=e)),we=e=>se((t=>ue(t)&&t>=e)),_e=()=>se((e=>ue(e)&&Number.isInteger(e))),Ee=()=>se((e=>ue(e)&&Number.isFinite(e))),Se=()=>se((e=>ue(e)&&e>0)),je=()=>se((e=>ue(e)&&e<0)),xe=e=>Object.assign(te(e),{between:(t,r)=>xe(ae(e,ye(t,r))),lt:t=>xe(ae(e,ve(t))),gt:t=>xe(ae(e,be(t))),lte:t=>xe(ae(e,Oe(t))),gte:t=>xe(ae(e,we(t))),int:()=>xe(ae(e,_e())),finite:()=>xe(ae(e,Ee())),positive:()=>xe(ae(e,Se())),negative:()=>xe(ae(e,je()))}),Pe=xe(se(ue)),Te=(e,t)=>se((r=>pe(r)&&e<=r&&t>=r)),ze=e=>se((t=>pe(t)&&t<e)),Ne=e=>se((t=>pe(t)&&t>e)),Fe=e=>se((t=>pe(t)&&t<=e)),Ce=e=>se((t=>pe(t)&&t>=e)),ke=()=>se((e=>pe(e)&&e>0)),De=()=>se((e=>pe(e)&&e<0)),Me=e=>Object.assign(te(e),{between:(t,r)=>Me(ae(e,Te(t,r))),lt:t=>Me(ae(e,ze(t))),gt:t=>Me(ae(e,Ne(t))),lte:t=>Me(ae(e,Fe(t))),gte:t=>Me(ae(e,Ce(t))),positive:()=>Me(ae(e,ke())),negative:()=>Me(ae(e,De()))}),Ae=Me(se(pe)),Re=te(se((function(e){return"boolean"==typeof e}))),Ie=te(se((function(e){return"symbol"==typeof e}))),Le=te(se((function(e){return null==e})));var $e={__proto__:null,matcher:U,optional:ne,array:function(...e){return re({[U]:()=>({match:t=>{if(!Array.isArray(t))return{matched:!1};if(0===e.length)return{matched:!0};const r=e[0];let n={};if(0===t.length)return Z(r).forEach((e=>{n[e]=[]})),{matched:!0,selections:n};const i=(e,t)=>{n[e]=(n[e]||[]).concat([t])};return{matched:t.every((e=>X(r,e,i))),selections:n}},getSelectionKeys:()=>0===e.length?[]:Z(e[0])})})},set:function(...e){return te({[U]:()=>({match:t=>{if(!(t instanceof Set))return{matched:!1};let r={};if(0===t.size)return{matched:!0,selections:r};if(0===e.length)return{matched:!0};const n=(e,t)=>{r[e]=(r[e]||[]).concat([t])},i=e[0];return{matched:ie(t,(e=>X(i,e,n))),selections:r}},getSelectionKeys:()=>0===e.length?[]:Z(e[0])})})},map:function(...e){return te({[U]:()=>({match:t=>{if(!(t instanceof Map))return{matched:!1};let r={};if(0===t.size)return{matched:!0,selections:r};const n=(e,t)=>{r[e]=(r[e]||[]).concat([t])};if(0===e.length)return{matched:!0};var i;if(1===e.length)throw new Error(`\`P.map\` wasn't given enough arguments. Expected (key, value), received ${null==(i=e[0])?void 0:i.toString()}`);const[o,a]=e;return{matched:oe(t,((e,t)=>{const r=X(o,t,n),i=X(a,e,n);return r&&i})),selections:r}},getSelectionKeys:()=>0===e.length?[]:[...Z(e[0]),...Z(e[1])]})})},intersection:ae,union:le,not:function(e){return te({[U]:()=>({match:t=>({matched:!X(e,t,(()=>{}))}),getSelectionKeys:()=>[],matcherType:"not"})})},when:se,select:ce,any:he,_:fe,string:ge,between:ye,lt:ve,gt:be,lte:Oe,gte:we,int:_e,finite:Ee,positive:Se,negative:je,number:Pe,betweenBigInt:Te,ltBigInt:ze,gtBigInt:Ne,lteBigInt:Fe,gteBigInt:Ce,positiveBigInt:ke,negativeBigInt:De,bigint:Ae,boolean:Re,symbol:Ie,nullish:Le,instanceOf:function(e){return te(se(function(e){return t=>t instanceof e}(e)))},shape:function(e){return te(se(function(...e){if(1===e.length){const[t]=e;return e=>X(t,e,(()=>{}))}if(2===e.length){const[t,r]=e;return X(t,r,(()=>{}))}throw new Error(`isMatching wasn't given the right number of arguments: expected 1 or 2, received ${e.length}.`)}(e)))}};function Ve(e){return new Be(e)}const We={matched:!1,value:void 0};class Be{constructor(e,t=We){this.input=void 0,this.state=void 0,this.input=e,this.state=t}with(...e){if(this.state.matched)return this;const t=e[e.length-1],r=[e[0]],n=[];3===e.length&&"function"==typeof e[1]?(r.push(e[0]),n.push(e[1])):e.length>2&&r.push(...e.slice(1,e.length-1));let i={};const o=Boolean(r.some((e=>X(e,this.input,((e,t)=>{i[e]=t}))))&&n.every((e=>e(this.input))))?{matched:!0,value:t(Object.keys(i).length?Q in i?i[Q]:i:this.input,this.input)}:We;return new Be(this.input,o)}when(e,t){if(this.state.matched)return this;const r=Boolean(e(this.input));return new Be(this.input,r?{matched:!0,value:t(this.input,this.input)}:We)}otherwise(e){return this.state.matched?this.state.value:e(this.input)}exhaustive(){return this.run()}run(){if(this.state.matched)return this.state.value;let e;try{e=JSON.stringify(this.input)}catch(t){e=this.input}throw new Error(`Pattern matching error: no pattern matches value ${e}`)}returnType(){return this}}const He=(0,t.stylesFactory)((({theme:e,name:r})=>{const{color:n,borderColor:o}=(0,t.getTagColorsFromName)(r),a=e.spacing.formInputHeight-8;return{itemStyle:i.css`
      display: flex;
      align-items: center;
      height: ${a}px;
      line-height: ${a-2}px;
      background-color: ${n};
      color: ${e.palette.white};
      border: 1px solid ${o};
      border-radius: 3px;
      padding: 0 ${e.spacing.xs};
      margin-right: 3px;
      white-space: nowrap;
      text-shadow: none;
      font-weight: 500;
      font-size: ${e.typography.size.sm};
    `,nameStyle:i.css`
      margin-right: 3px;
    `,buttonStyles:i.css`
      margin: 0;
      &:hover::before {
        display: none;
      }
    `}})),qe=({name:e,value:r,onRemove:i})=>{const o=(0,t.useTheme)(),a=He({theme:o,name:e}),l=Ve(typeof r).with("string",(()=>`"${r}"`)).with("number",(()=>r)).with("boolean",(()=>r.toString())).with("object",(()=>null===r?"null":`"${JSON.stringify(r)}"`)).otherwise((()=>`"${JSON.stringify(r)}"`));return n().createElement("div",{className:a.itemStyle},n().createElement("span",{className:a.nameStyle},e,"=",l),n().createElement(t.IconButton,{name:"times",size:"lg",ariaLabel:`Remove ${e}`,onClick:()=>i(e),type:"button",className:a.buttonStyles}))};function Je(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ue(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Je(e,t,r[t])}))}return e}function Ke(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const Qe=e=>{const{datasource:r,onChange:i,onRunQuery:o,query:a}=e,[l,s]=n().useState();var c;const[u,d]=n().useState(null!==(c=e.payload)&&void 0!==c?c:""),[p,h]=n().useState([]),[f,m]=n().useState(null),[g,y]=n().useState([]),[v,b]=n().useState([]),[O,w]=n().useState(!1),_=n().useCallback((()=>{var e,t;return r.listMetrics(null!==(t=null!==(e=l?.value)&&void 0!==e?e:a.target)&&void 0!==t?t:"",u).then((e=>{const t=(0,V.find)(e,(e=>e.value===a.target));var r;return s(void 0===t?{label:"",value:""}:{label:t.label,value:t.value}),y(null!==(r=t?.payloads)&&void 0!==r?r:[]),e}),(e=>{throw s({label:"",value:""}),b([]),new Error(e.statusText)}))}),[r,u,l?.value]),S=n().useCallback((()=>{w(!0),_().then((e=>{b(e)})).finally((()=>{w(!1)}))}),[_,b,w]);n().useEffect((()=>S()),[]),n().useEffect((()=>{void 0!==l?.value&&""!==l?.value&&(null!==f&&l?.value===f.metric&&u===f.payload||(m({payload:u,metric:l.value.toString()}),i(Ke(Ue({},a),{payload:u,target:l.value.toString()})),o()))}),[u,l]),n().useEffect((()=>{const e=[];for(const t in u)void 0===g.find((e=>e.name===t))&&e.push({name:t,value:u[t]}),h(e)}),[u,g]);const j=(e,t,n)=>{d((i=>{let o=Ue({},i);var c;return(0,V.isArray)(n)?o[e]=n.map((e=>e.value)).filter((e=>void 0!==e&&e.toString().length>0)):n&&void 0!==n.value&&""!==n.value?o[e]=n.value:delete o[e],t&&(w(!0),r.listMetrics(null!==(c=l?.value)&&void 0!==c?c:"",Ue({},o)).then((e=>{const t=(0,V.find)(e,(e=>e.value===a.target));var r;s(void 0===t?{label:"",value:""}:t),y(null!==(r=t?.payloads)&&void 0!==r?r:[]),b(e)}),(e=>{throw s({label:"",value:""}),b([]),new Error(e.statusText)})).finally((()=>{w(!1)}))),o}))};return n().createElement(n().Fragment,null,n().createElement(E,null,n().createElement(F,{label:"Metric"},n().createElement(t.Select,{isLoading:O,options:v,placeholder:"Select metric",allowCustomValue:!0,value:l,onOpenMenu:()=>{0===S.length&&S()},onChange:e=>{const t=v.find((t=>t.value===e.value));var r;y(null!==(r=t?.payloads)&&void 0!==r?r:[]),s(e)}}))),g.length>0&&n().createElement(E,null,n().createElement(F,{label:"Payload",style:{width:"100%"}},n().createElement("div",{style:{display:"flex",flexFlow:"row wrap",gap:16,width:"100%"}},g.map((r=>{switch(r.type){case"select":case"multi-select":return n().createElement(t.InlineField,{key:r.name,style:{display:"inline-flex"}},n().createElement(J,Ke(Ue({},e),{config:r,value:u[r.name],isMulti:"multi-select"===r.type,onPayloadChange:e=>{j(r.name,r.reloadMetric,e)}})));case"textarea":var i;return n().createElement(t.InlineField,{key:r.name,style:{width:"100%",display:"inline"}},n().createElement("div",{style:{width:"100%",display:"flex"}},n().createElement("label",{className:"gf-form-label"},null!==(i=r.label)&&void 0!==i?i:r.label),n().createElement(H,{config:r,value:u[r.name],onValueChange:e=>{j(r.name,r.reloadMetric,{value:e})}})));default:var o;return n().createElement(t.InlineField,{key:r.name,style:{display:"inline-flex"}},n().createElement(t.Input,{prefix:r.label,width:r.width,onBlur:e=>{j(r.name,r.reloadMetric,{value:e.currentTarget.value})},defaultValue:u[r.name],placeholder:null!==(o=r.placeholder)&&void 0!==o?o:""}))}}))))),p.length>0&&n().createElement(E,null,n().createElement(F,{label:"Unknown payload",tooltip:n().createElement(n().Fragment,null,"Payload options that are set but not defined in the ",n().createElement("code",null,"Metric.payloads"),".")},n().createElement("div",{style:{display:"flex",flexFlow:"row wrap",gap:16,width:"100%"}},p.map(((e,t)=>n().createElement(qe,{key:`${e.name}-${t}`,name:e.name,value:e.value,onRemove:()=>{j(e.name,!1,{value:""})}})))))))};function Ge(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ye(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Ge(e,t,r[t])}))}return e}function Xe(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function Ze(e){if(!e)return{};if("string"!=typeof e)return e;try{return JSON.parse(e)}catch(e){return console.error(e),{}}}var et=c(545),tt=c(177);function rt(e){return"function"==typeof e}var nt=function(e,t){return nt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},nt(e,t)};function it(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}nt(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function ot(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function at(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,o=r.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)a.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return a}function lt(e,t,r){if(r||2===arguments.length)for(var n,i=0,o=t.length;i<o;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))}Object.create,Object.create;var st,ct,ut=(st=function(e){return function(t){e(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t}},(ct=st((function(e){Error.call(e),e.stack=(new Error).stack}))).prototype=Object.create(Error.prototype),ct.prototype.constructor=ct,ct);function dt(e,t){if(e){var r=e.indexOf(t);0<=r&&e.splice(r,1)}}var pt=function(){function e(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}var t;return e.prototype.unsubscribe=function(){var e,t,r,n,i;if(!this.closed){this.closed=!0;var o=this._parentage;if(o)if(this._parentage=null,Array.isArray(o))try{for(var a=ot(o),l=a.next();!l.done;l=a.next())l.value.remove(this)}catch(t){e={error:t}}finally{try{l&&!l.done&&(t=a.return)&&t.call(a)}finally{if(e)throw e.error}}else o.remove(this);var s=this.initialTeardown;if(rt(s))try{s()}catch(e){i=e instanceof ut?e.errors:[e]}var c=this._finalizers;if(c){this._finalizers=null;try{for(var u=ot(c),d=u.next();!d.done;d=u.next()){var p=d.value;try{ht(p)}catch(e){i=null!=i?i:[],e instanceof ut?i=lt(lt([],at(i)),at(e.errors)):i.push(e)}}}catch(e){r={error:e}}finally{try{d&&!d.done&&(n=u.return)&&n.call(u)}finally{if(r)throw r.error}}}if(i)throw new ut(i)}},e.prototype.add=function(t){var r;if(t&&t!==this)if(this.closed)ht(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!==(r=this._finalizers)&&void 0!==r?r:[]).push(t)}},e.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},e.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},e.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&dt(t,e)},e.prototype.remove=function(t){var r=this._finalizers;r&&dt(r,t),t instanceof e&&t._removeParent(this)},e.EMPTY=((t=new e).closed=!0,t),e}();function ht(e){rt(e)?e():e.unsubscribe()}pt.EMPTY;var ft={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},mt={setTimeout:function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];var i=mt.delegate;return(null==i?void 0:i.setTimeout)?i.setTimeout.apply(i,lt([e,t],at(r))):setTimeout.apply(void 0,lt([e,t],at(r)))},clearTimeout:function(e){var t=mt.delegate;return((null==t?void 0:t.clearTimeout)||clearTimeout)(e)},delegate:void 0};function gt(){}var yt=vt("C",void 0,void 0);function vt(e,t,r){return{kind:e,value:t,error:r}}var bt=function(e){function t(t){var r,n=e.call(this)||this;return n.isStopped=!1,t?(n.destination=t,((r=t)instanceof pt||r&&"closed"in r&&rt(r.remove)&&rt(r.add)&&rt(r.unsubscribe))&&t.add(n)):n.destination=xt,n}return it(t,e),t.create=function(e,t,r){return new Et(e,t,r)},t.prototype.next=function(e){this.isStopped?jt(function(e){return vt("N",e,void 0)}(e),this):this._next(e)},t.prototype.error=function(e){this.isStopped?jt(vt("E",void 0,e),this):(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped?jt(yt,this):(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(pt),Ot=Function.prototype.bind;function wt(e,t){return Ot.call(e,t)}var _t=function(){function e(e){this.partialObserver=e}return e.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(e){St(e)}},e.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(e){St(e)}else St(e)},e.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(e){St(e)}},e}(),Et=function(e){function t(t,r,n){var i,o,a=e.call(this)||this;return rt(t)||!t?i={next:null!=t?t:void 0,error:null!=r?r:void 0,complete:null!=n?n:void 0}:a&&ft.useDeprecatedNextContext?((o=Object.create(t)).unsubscribe=function(){return a.unsubscribe()},i={next:t.next&&wt(t.next,o),error:t.error&&wt(t.error,o),complete:t.complete&&wt(t.complete,o)}):i=t,a.destination=new _t(i),a}return it(t,e),t}(bt);function St(e){ft.useDeprecatedSynchronousErrorHandling?(e,ft.useDeprecatedSynchronousErrorHandling):function(e){mt.setTimeout((function(){var t=ft.onUnhandledError;if(!t)throw e;t(e)}))}(e)}function jt(e,t){var r=ft.onStoppedNotification;r&&mt.setTimeout((function(){return r(e,t)}))}var xt={closed:!0,next:gt,error:function(e){throw e},complete:gt},Pt=function(e){function t(t,r,n,i,o,a){var l=e.call(this,t)||this;return l.onFinalize=o,l.shouldUnsubscribe=a,l._next=r?function(e){try{r(e)}catch(e){t.error(e)}}:e.prototype._next,l._error=i?function(e){try{i(e)}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._error,l._complete=n?function(){try{n()}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._complete,l}return it(t,e),t.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var r=this.closed;e.prototype.unsubscribe.call(this),!r&&(null===(t=this.onFinalize)||void 0===t||t.call(this))}},t}(bt);function Tt(e,t){return r=function(r,n){var i=0;r.subscribe(new Pt(n,(function(r){n.next(e.call(t,r,i++))}),void 0,void 0,void 0))},function(e){if(function(e){return rt(null==e?void 0:e.lift)}(e))return e.lift((function(e){try{return r(e,this)}catch(e){this.error(e)}}));throw new TypeError("Unable to lift unknown Observable type")};var r}class zt{transformMetricFindResponse(t){const r=(0,e.toDataFrame)(t.data),n=[],i=r.fields.find((e=>"__text"===e.name)),o=r.fields.find((e=>"__value"===e.name));if(i&&o)for(let e=0;e<i.values.length;e++)n.push({text:""+i.values.get(e),value:""+o.values.get(e)});else n.push(...r.fields.flatMap((e=>e.values.toArray())).map((e=>({text:e}))));return Array.from(new Set(n.map((e=>e.text)))).map((e=>{var t;return{text:e,value:null===(t=n.find((t=>t.text===e)))||void 0===t?void 0:t.value}}))}}function Nt(e,t,r,n,i,o,a){try{var l=e[o](a),s=l.value}catch(e){return void r(e)}l.done?t(s):Promise.resolve(s).then(n,i)}function Ft(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ct(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Ft(e,t,r[t])}))}return e}function kt(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}class Dt extends e.DataSourceApi{query(t){const r=this.processTargets(t);return 0===r.targets.length?Promise.resolve({data:[]}):(r.adhocFilters=(0,et.getTemplateSrv)().getAdhocFilters(this.name),t.scopedVars=Ct({},this.getVariables(),t.scopedVars),(0,tt.lastValueFrom)(this.doFetch({url:`${this.url}/query`,data:r,method:"POST"}).pipe(Tt((t=>(t.data=t.data.map(e.toDataFrame),t))))))}testDatasource(){var e,t=this;return(e=function*(){const e="Data source is not working";try{const r=yield(0,tt.lastValueFrom)(t.doFetch({url:t.url,method:"GET"}).pipe(Tt((e=>e))));return 200===r.status?{status:"success",message:"Data source is working",title:"Success"}:{message:r.statusText?r.statusText:e,status:"error",title:"Error"}}catch(t){var r,n;if("string"==typeof t)return{status:"error",message:t};let o=t;var i;let a=null!==(i=o.statusText)&&void 0!==i?i:e;return void 0!==(null===(n=o.data)||void 0===n||null===(r=n.error)||void 0===r?void 0:r.code)&&(a+=`: ${o.data.error.code}. ${o.data.error.message}`),{status:"error",message:a,title:"Error"}}},function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function a(e){Nt(o,n,i,a,l,"next",e)}function l(e){Nt(o,n,i,a,l,"throw",e)}a(void 0)}))})()}metricFindQuery(e,t,r){var n,i;const o={payload:"json"===e.format?JSON.parse((0,et.getTemplateSrv)().replace(e.query,void 0,"json")):{type:r,target:(0,et.getTemplateSrv)().replace(e.query,void 0,"regex")},range:null===(n=t)||void 0===n?void 0:n.range,rangeRaw:null===(i=t)||void 0===i?void 0:i.rangeRaw};return(0,tt.lastValueFrom)(this.doFetch({url:`${this.url}/variable`,data:o,method:"POST"}).pipe(Tt((e=>this.responseParser.transformMetricFindResponse(e)))))}listMetricPayloadOptions(e,t,r){return(0,tt.lastValueFrom)(this.doFetch({url:`${this.url}/metric-payload-options`,data:{metric:t,payload:this.processPayload(r,"builder",void 0),name:e},method:"POST"}).pipe(Tt((e=>(0,V.isArray)(e.data)?e.data.map((e=>kt(Ct({},e),{label:e.label?e.label:e.value}))):[]))))}listMetrics(e,t){return(0,tt.lastValueFrom)(this.doFetch({url:`${this.url}/metrics`,data:{metric:e.toString()?(0,et.getTemplateSrv)().replace(e.toString(),void 0,"regex"):void 0,payload:t?this.processPayload(t,"builder",void 0):void 0},method:"POST"}).pipe(Tt((e=>(0,V.isArray)(e.data)?e.data.map((e=>{return"string"==typeof e?{value:e,label:e,payloads:[]}:kt(Ct({},e),{payloads:(0,V.isArray)(e.payloads)?e.payloads.map((e=>kt(Ct({},e),{label:e.label?e.label:e.name}))):[],label:null!==(t=e.label)&&void 0!==t?t:e.value});var t})):[]))))}getTagKeys(e){return(0,tt.lastValueFrom)(this.doFetch({url:`${this.url}/tag-keys`,method:"POST",data:e}).pipe(Tt((e=>e.data))))}getTagValues(e){return(0,tt.lastValueFrom)(this.doFetch({url:`${this.url}/tag-values`,method:"POST",data:e}).pipe(Tt((e=>e.data))))}mapToTextValue(e){return e.data.map(((e,t)=>e&&e.text&&e.value?{text:e.text,value:e.value}:(0,V.isObject)(e)?{text:e,value:t}:{text:e,value:e}))}doFetch(e){return e.credentials=this.withCredentials?"include":"same-origin",e.headers=this.headers,(0,et.getBackendSrv)().fetch(e)}processPayload(e,t,r){try{if("string"==typeof e&&"builder"!==t)return""!==e.trim()?JSON.parse(e.replace((0,et.getTemplateSrv)().regex,(e=>this.cleanMatch(e,{scopedVars:r})))):{};{const t="string"==typeof e?JSON.parse(e):Ct({},e);for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e)){const n=t[e];(0,V.isArray)(n)?t[e]=n.map((e=>(0,et.getTemplateSrv)().replace(e.toString(),r,"regex"))):t[e]=(0,et.getTemplateSrv)().replace(t[e].toString(),r,"regex")}return t}}catch(e){return{}}}processTarget(e,t){const r=Ct({},e);var n;return r.payload=this.processPayload(null!==(n=r.payload)&&void 0!==n?n:"",r.editorMode,t),"string"==typeof r.target&&(r.target=(0,et.getTemplateSrv)().replace(r.target.toString(),t,"regex")),r}processTargets(e){return e.targets=e.targets.filter((e=>void 0!==e.target)).map((t=>this.processTarget(t,e.scopedVars))),e}cleanMatch(e,t){const r=(0,et.getTemplateSrv)().replace(e,t.scopedVars,"json");return'"'===r[0]&&'"'===r[r.length-1]?JSON.parse(r):r}getVariables(){const e={};return Object.values((0,et.getTemplateSrv)().getVariables()).forEach((t=>{if("adhoc"===t.type)return;if("system"===t.type)return;const r=Ve(t).with({type:$e.union("custom","query")},(e=>(e=>{let t=e.current.value;return("$__all"===t||(0,V.isEqual)(t,["$__all"]))&&(t=null===e.allValue||""===e.allValue||void 0===e.allValue?e.options.slice(1).map((t=>{if("string"!=typeof t.value){const r=new Error("Variable option value is not a string");throw console.error(r.message,t,e),r}return t.value})):e.allValue),t})(e))).with({type:$e.union("constant","datasource","interval","textbox")},(e=>e.current.value)).exhaustive();void 0!==r&&(e[t.id]={selected:!1,text:t.current.text,value:r})})),e}constructor(e){var t,r;super(e),Ft(this,"url",void 0),Ft(this,"withCredentials",void 0),Ft(this,"headers",void 0),Ft(this,"responseParser",void 0),Ft(this,"defaultEditorMode",void 0),Ft(this,"annotations",{}),this.responseParser=new zt,this.defaultEditorMode=null!==(r=null===(t=e.jsonData)||void 0===t?void 0:t.defaultEditorMode)&&void 0!==r?r:"code",this.url=void 0===e.url?"":e.url,this.withCredentials=void 0!==e.withCredentials,this.headers={"Content-Type":"application/json"},"string"==typeof e.basicAuth&&e.basicAuth.length>0&&(this.headers.Authorization=e.basicAuth)}}function Mt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function At(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Mt(e,t,r[t])}))}return e}function Rt(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const It=new e.DataSourcePlugin(Dt).setConfigEditor((({options:e,onOptionsChange:r})=>n().createElement(n().Fragment,null,n().createElement(t.DataSourceHttpSettings,{defaultUrl:"http://localhost:8080",dataSourceConfig:e,showAccessOptions:!0,onChange:r}),n().createElement("h3",{className:"page-heading"},"Other"),n().createElement("div",{className:"gf-form-group"},n().createElement("div",{className:"gf-form-inline"},n().createElement("div",{className:"gf-form"},n().createElement(h,{label:"Default edit mode",labelWidth:13,inputEl:n().createElement(l,{size:"md",mode:null!==(f=e.jsonData.defaultEditorMode)&&void 0!==f?f:"code",onChange:t=>{r(p(d({},e),{jsonData:p(d({},e.jsonData),{defaultEditorMode:t})}))}})}))))))).setQueryEditor((e=>{const{onChange:i,query:o,datasource:a}=e,{defaultEditorMode:s}=a,c=o.editorMode,[u,d]=n().useState(!1);n().useEffect((()=>{var e;i(Xe(Ye({},o),{editorMode:null!==(e=o.editorMode)&&void 0!==e?e:s}))}),[]);const p=(0,r.useCallback)((e=>{i(Xe(Ye({},o),{editorMode:e}))}),[i,o]);return n().createElement(n().Fragment,null,n().createElement(m,null,n().createElement(t.InlineField,{label:"Mode"},n().createElement(l,{size:"md",mode:c,onChange:p})),n().createElement(t.InlineField,{label:"Raw query"},n().createElement(t.InlineSwitch,{sizes:"md",label:"Raw query",value:u,onChange:e=>d(e.currentTarget.checked)}))),n().createElement(_,null,"code"===(null!=c?c:s)&&n().createElement(B,Xe(Ye({},e),{payload:(h=o.payload,"string"==typeof h?h:h?JSON.stringify(h,void 0,2):"")})),"builder"===(null!=c?c:s)&&n().createElement(Qe,Xe(Ye({},e),{payload:Ze(o.payload)}))),u&&n().createElement(E,null,n().createElement(F,{label:"Raw query",width:"100%",style:{width:"100%"}},n().createElement($,{disableHeight:!0},(({width:e})=>n().createElement("div",{style:{width:e+"px"}},n().createElement(t.CodeEditor,{width:"100%",height:"200px",readOnly:!0,value:JSON.stringify(a.processTarget(o),void 0,2),onBlur:()=>{},language:"json"})))))));var h})).setVariableQueryEditor((({onChange:e,query:i})=>{const[o,a]=(0,r.useState)(i),l=()=>{e(o,`${o.query}`+("json"===o.format?" (JSON)":""))};return n().createElement(n().Fragment,null,n().createElement(t.InlineFieldRow,null,n().createElement(t.InlineField,{label:"Query",invalid:(e=>{if("json"===e.format){const t=(0,et.getTemplateSrv)().replace(e.query,void 0,"json");try{JSON.parse(t)}catch(e){if(e instanceof Error&&"SyntaxError"===e.name)return!0;throw e}}return!1})(o),grow:!0},n().createElement(t.Input,{name:"query",onBlur:l,onChange:e=>a(Rt(At({},o),{query:e.currentTarget.value})),value:o.query})),n().createElement(t.InlineField,{labelWidth:14,label:"Raw JSON",tooltip:"When enabled, the query string is parsed as a JSON object. Otherwise when disabled, the query string is placed into a 'target' key to create a JSON object."},n().createElement(t.InlineSwitch,{name:"format",onBlur:l,onChange:e=>a(Rt(At({},o),{format:e.currentTarget.checked?"json":"string"})),value:(s=o.format,"json"===s)}))));var s}))})(),u})()));
//# sourceMappingURL=module.js.map